{% extends 'layouts/bases.html' %}
{% load static %}

{% block css%}
<link href="{% static 'pulls/assets/css/vendor/dataTables.bootstrap5.css' %}" rel="stylesheet" type="text/css" />
<link href="{% static 'pulls/assets/css/vendor/responsive.bootstrap5.css' %}" rel="stylesheet" type="text/css" />
{%endblock%}

{% block content %}
                        
    <!-- start page title -->
    <div class="row">
        <div class="col-12">
            <div class="page-title-box">
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="javascript: void(0);">R&S-TELECOM</a></li>
                        <li class="breadcrumb-item"><a href="javascript: void(0);">Application</a></li>
                        <li class="breadcrumb-item active">Employés</li>
                    </ol>
                </div>
                <h4 class="page-title">Employés</h4>
            </div>
        </div>
    </div>
    <!-- end page title -->
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-sm-4">
                            <a href="javascript:void(0);" id="suiviConsultantBtn" class="btn btn-primary mb-2 text-capitalize">Suivi consultant <i class="mdi mdi-account-arrow-right mx-2"></i> </a>
                            <a href="javascript:void(0);" class="btn btn-light mb-2 fw-bold mx-2">Aout 2024 </a>
                        </div>
                        <div class="col-sm-8">
                            <div class="text-sm-end">
                                <button type="button" class="btn btn-success mb-2 me-1"><i class="mdi mdi-cog"></i></button>
                                <button type="button" class="btn btn-light mb-2 me-1">Import</button>
                                <button type="button" class="btn btn-light mb-2">Export</button>
                            </div>
                        </div><!-- end col-->
                    </div>
    
                    <div class="table-responsive" id="employeeTable">
                        <table class="table table-centered table-striped dt-responsive nowrap w-100" id="products-datatable">
                            <thead>
                                <tr>
                                    <th style="width: 20px;">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="customCheck1">
                                            <label class="form-check-label" for="customCheck1">&nbsp;</label>
                                        </div>
                                    </th>
                                    <th>Employé</th>
                                    <th>telephone</th>
                                    <th>Adresse email</th>
                                    <th>Entreprise</th>
                                    <th>Job position</th>
                                    <th>Manager</th>
                                    <th style="width: 75px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="customCheck13">
                                            <label class="form-check-label" for="customCheck13">&nbsp;</label>
                                        </div>
                                    </td>
                                    <td class="table-user">
                                        <img src="{% if user.profile_photo %} /media/photos_profil/{{ user.url_photo_profile }}{% else %}{% static 'images/logo.png' %}{% endif %}" alt="table-user" class="me-2 rounded-circle">
                                        <a href="javascript:void(0);" class="text-body fw-semibold">{{ user.0.users_name|default:"N/A" }} {{ user.0.users_fname|default:"N/A" }}</a>
                                    </td>
                                    <td>
                                        {{ user.0.users_phone|default:"N/A" }}
                                    </td>
                                    <td>
                                        {{ user.0.users_mail|default:"N/A" }}
                                    </td>
                                    <td>
                                        {{ user.0.users_company|default:"N/A" }}
                                    </td>
                                    <td>
                                        {{ user.1|default:"N/A" }}
                                    </td>
                                    <td>
                                        {% if user.0.users_is_active %}
                                            <span class="badge badge-success-lighten">N/A</span>
                                        {% else %}
                                            <span class="badge badge-danger-lighten">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'edith_profil' user.0.id_user %}" class="action-icon"> <i class="mdi mdi-square-edit-outline text-primary"></i></a>
                                        <a href="#" class="action-icon delete-user" data-id="{{user.id_user}}" id="delete_user" data-url="{% url 'deleteEmployes' user.0.id_user%}"> <i class="mdi mdi-account-remove-outline text-danger"></i></a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
    
                    <div class="table-responsive d-none" id="consultantTable">
                        <table class="table table-centered table-striped dt-responsive nowrap w-100" id="consultants-datatable">
                            <thead>
                                <tr>
                                    <th style="width: 20px;">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="customCheck2">
                                            <label class="form-check-label" for="customCheck2">&nbsp;</label>
                                        </div>
                                    </th>
                                    <th>Consultant</th>
                                    <th>Adresse email</th>
                                    <th>Client</th>
                                    <th>Manager</th>
                                    <th>Nombre de jour </th>
                                    <th>status</th>
                                    <th style="width: 75px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for consultant in consultants %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="customCheck23">
                                            <label class="form-check-label" for="customCheck23">&nbsp;</label>
                                        </div>
                                    </td>
                                    <td class="table-user">
                                        <img src="{% if consultant.profile_photo %} /media/photos_profil/{{ consultant.url_photo_profile }}{% else %}{% static 'images/logo.png' %}{% endif %}" alt="table-user" class="me-2 rounded-circle">
                                        <a href="javascript:void(0);" class="text-body fw-semibold">{{ consultant.0.users_name|default:"N/A" }} {{ consultant.0.users_fname|default:"N/A" }}</a>
                                    </td>
                                    <td>
                                        {{ consultant.0.users_phone|default:"N/A" }}
                                    </td>
                                    <td>
                                        {{ consultant.0.users_mail|default:"N/A" }}
                                    </td>
                                    <td>
                                        {{ consultant.0.users_company|default:"N/A" }}
                                    </td>
                                    <td>
                                        {{ consultant.1|default:"N/A" }}
                                    </td>
                                    <td>
                                        {% if consultant.0.users_is_active %}
                                            <span class="badge badge-success-lighten">N/A</span>
                                        {% else %}
                                            <span class="badge badge-danger-lighten">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'edith_profil' consultant.0.id_user %}" class="action-icon"> <i class="mdi mdi-square-edit-outline text-primary"></i></a>
                                        <a href="#" class="action-icon delete-user" data-id="{{consultant.id_user}}" id="delete_user" data-url="{% url 'deleteConsultants' consultant.0.id_user%}"> <i class="mdi mdi-account-remove text-danger"></i></a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div> <!-- end card-body-->
            </div> <!-- end card-->
        </div> <!-- end col -->
    </div>
    <!-- end row -->
    <div id="warning-alert-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body p-4">
                    <div class="text-center">
                        <i id="modal-icon"></i>
                        <h4 class="mt-2" id="message-title"></h4>
                        <p class="mt-3" id="message-body"></p>
                        <button type="button" id="validation" class="btn my-2">Confirmer</button>
                        <button type="button" id="Annuler" class="btn my-2" data-bs-dismiss="modal">Annuler</button>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
{% endblock %}

{% block js %}
<!-- <script src="{% static 'pulls/assets/js/vendor/jquery.dataTables.min.js' %}"></script>
 -->
<script src="{% static 'pulls/assets/js/vendor/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'pulls/assets/js/vendor/dataTables.bootstrap5.js' %}"></script>
<script src="{% static 'pulls/assets/js/vendor/responsive.bootstrap5.min.js' %}"></script>
<script src="{% static 'pulls/assets/js/vendor/dataTables.checkboxes.min.js' %}"></script>
<script src="{% static 'pulls/assets/js/vendor/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'pulls/assets/js/pages/demo.customers.js' %}"></script>
<script>
        $(document).ready(function() {
            
            document.getElementById('suiviConsultantBtn').addEventListener('click', function() {
            var employeeTable = document.getElementById('employeeTable');
            var consultantTable = document.getElementById('consultantTable');
            if (employeeTable.classList.contains('d-none')) {
                employeeTable.classList.remove('d-none');
                consultantTable.classList.add('d-none');
                document.getElementById('suiviConsultantBtn').innerHTML=`Suivi consultant <i class="mdi mdi-account-arrow-right fs-4 mx-2"></i>`;
            } else {
                employeeTable.classList.add('d-none');
                consultantTable.classList.remove('d-none');
                document.getElementById('suiviConsultantBtn').innerHTML=`Employés <i class="mdi mdi-account-arrow-left fs-4 mx-2"></i>`;
            }
        });

        $(document).on('click', '.delete-user', function() {
            var userId = $(this).data('id');
            const button=document.getElementById('validation');
            showModal('erreur-suppression   ','Confimation de la suppression', 'Souhaitez-vous vraiment supprimer cet utilisateur?');
            button.addEventListener('click',function(){
                deleteUser(userId);
            })
        });

    });

    function showModal(type,title, message, confirmCallback) {
        $('#message-title').text(title);
        $('#message-body').text(message);
        var modalIcon = $('#modal-icon');
        var button = $('#validation');
        var buttonAnnul = $('#Annuler');
        modalIcon.removeClass().addClass('h1');
        button.removeClass();
        // Modifier la classe de l'icône en fonction du titre
        if (type.toLowerCase().includes('succès')) {
            modalIcon.addClass('dripicons-checkmark text-success');
            button.addClass('btn btn-success d-none');
            buttonAnnul.addClass('btn btn-success')

        } else if (type.toLowerCase().includes('erreur')) {

            if(type.toLowerCase().includes('erreur-suppression')) {
                modalIcon.addClass('mdi mdi-delete-forever text-danger');
                button.addClass('btn btn-danger');
                buttonAnnul.removeClass('d-none')
            }
            else{
                modalIcon.addClass('dripicons-cross text-danger');
                button.addClass('btn btn-danger d-none');
                buttonAnnul.addClass('btn btn-danger ')
            }
        }
         else {
            modalIcon.addClass('dripicons-warning text-warning');
            button.addClass('btn btn-warning');
            buttonAnnul.addClass('d-none')
        }

        // Afficher la modal
        var modal = new bootstrap.Modal(document.getElementById('warning-alert-modal'));
        modal.show();
    }

    function deleteUser(userId) {
        var lien = document.getElementById('delete_user').getAttribute('data-url');
            $.ajax({
                url: lien ,
                type: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') // Function to get CSRF token
                },
                success: function(result) {
                    // let modal_url= document.getElementById('warning-alert-modal');
                    var modalId = document.getElementById('warning-alert-modal');
                    var modal = bootstrap.Modal.getInstance(modalId); 
                    if (modal) {
                        modal.hide();
                    }
                    showModal('Succès','opération réussie', 'Utilisateur supprimé avec succès.');
                },
                error: function(xhr, status, error) {
                    let modal_url= document.getElementById('warning-alert-modal');
                    var modal = new bootstrap.Modal.getOrCreateInstance(modal_url);
                    modal.hide();
                    showModal('Erreur','Erreur','Une erreur s\'est produite lors de la suppression de l\'utilisateur.');
                }
            });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
